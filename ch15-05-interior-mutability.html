<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>RefCell&lt;T&gt; and the Interior Mutability Pattern - The Rust Programming Language</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/ferris/ferris.css">
        <link rel="stylesheet" href="theme/2018-edition.css">
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('navy')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="not_involved_resources.html"><strong aria-hidden="true">1.</strong> Not Involved Resources</a></li><li class="chapter-item expanded "><a href="overviews.html"><strong aria-hidden="true">2.</strong> Overviews</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="overviews/rbe_radial_tree_embed.html"><strong aria-hidden="true">2.1.</strong> Rust By Examples</a></li></ol></li><li class="chapter-item expanded "><a href="title-page.html"><strong aria-hidden="true">3.</strong> Rust Topics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">3.1.</strong> Associated Items</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="topics/at_gat.html"><strong aria-hidden="true">3.1.1.</strong> Associated type, Generic associate types</a></li><li class="chapter-item "><div><strong aria-hidden="true">3.1.2.</strong> Associated Types</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/assoc_items/types.html"><strong aria-hidden="true">3.1.2.1.</strong> Associated types examples</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">3.1.3.</strong> Generic Associated Types</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.1.4.</strong> Associated Functions & Methods</div></li></ol></li></ol></li><li class="chapter-item expanded "><a href="title-page.html"><strong aria-hidden="true">4.</strong> The Rust Programming Language</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="foreword.html"><strong aria-hidden="true">4.1.</strong> Foreword</a></li><li class="chapter-item "><a href="ch00-00-introduction.html"><strong aria-hidden="true">4.2.</strong> Introduction</a></li><li class="chapter-item "><a href="ch01-00-getting-started.html"><strong aria-hidden="true">4.3.</strong> Getting Started</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch01-01-installation.html"><strong aria-hidden="true">4.3.1.</strong> Installation</a></li><li class="chapter-item "><a href="ch01-02-hello-world.html"><strong aria-hidden="true">4.3.2.</strong> Hello, World!</a></li><li class="chapter-item "><a href="ch01-03-hello-cargo.html"><strong aria-hidden="true">4.3.3.</strong> Hello, Cargo!</a></li><li class="chapter-item "><a href="ch02-00-guessing-game-tutorial.html"><strong aria-hidden="true">4.3.4.</strong> Programming a Guessing Game</a></li><li class="chapter-item "><a href="ch03-00-common-programming-concepts.html"><strong aria-hidden="true">4.3.5.</strong> Common Programming Concepts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch03-01-variables-and-mutability.html"><strong aria-hidden="true">4.3.5.1.</strong> ⚠️Variables and Mutability</a></li><li class="chapter-item "><a href="ch03-02-data-types.html"><strong aria-hidden="true">4.3.5.2.</strong> Data Types</a></li><li class="chapter-item "><a href="rust_by_example_src/expression.html"><strong aria-hidden="true">4.3.5.3.</strong> RBE(Rust by Examples): Expressions and Statements</a></li><li class="chapter-item "><a href="ch03-03-how-functions-work.html"><strong aria-hidden="true">4.3.5.4.</strong> ✨Functions</a></li><li class="chapter-item "><a href="ch03-04-comments.html"><strong aria-hidden="true">4.3.5.5.</strong> Comments</a></li><li class="chapter-item "><a href="ch03-05-control-flow.html"><strong aria-hidden="true">4.3.5.6.</strong> Control Flow</a></li></ol></li><li class="chapter-item "><a href="ch04-00-understanding-ownership.html"><strong aria-hidden="true">4.3.6.</strong> Understanding Ownership</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch04-01-what-is-ownership.html"><strong aria-hidden="true">4.3.6.1.</strong> What is Ownership?</a></li><li class="chapter-item "><a href="ch04-02-references-and-borrowing.html"><strong aria-hidden="true">4.3.6.2.</strong> References and Borrowing</a></li><li class="chapter-item "><a href="ch04-03-slices.html"><strong aria-hidden="true">4.3.6.3.</strong> The Slice Type</a></li></ol></li><li class="chapter-item "><a href="ch05-00-structs.html"><strong aria-hidden="true">4.3.7.</strong> Using Structs to Structure Related Data</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch05-01-defining-structs.html"><strong aria-hidden="true">4.3.7.1.</strong> Defining and Instantiating Structs</a></li><li class="chapter-item "><a href="ch05-02-example-structs.html"><strong aria-hidden="true">4.3.7.2.</strong> An Example Program Using Structs</a></li><li class="chapter-item "><a href="ch05-03-method-syntax.html"><strong aria-hidden="true">4.3.7.3.</strong> ✨Method Syntax</a></li></ol></li><li class="chapter-item "><a href="ch06-00-enums.html"><strong aria-hidden="true">4.3.8.</strong> Enums and Pattern Matching</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch06-01-defining-an-enum.html"><strong aria-hidden="true">4.3.8.1.</strong> Defining an Enum</a></li><li class="chapter-item "><a href="ch06-02-match.html"><strong aria-hidden="true">4.3.8.2.</strong> The match Control Flow Construct</a></li><li class="chapter-item "><a href="ch06-03-if-let.html"><strong aria-hidden="true">4.3.8.3.</strong> Concise Control Flow with if let</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">4.4.</strong> Basic Rust Literacy</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch07-00-managing-growing-projects-with-packages-crates-and-modules.html"><strong aria-hidden="true">4.4.1.</strong> Managing Growing Projects with Packages, Crates, and Modules</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch07-01-packages-and-crates.html"><strong aria-hidden="true">4.4.1.1.</strong> Packages and Crates</a></li><li class="chapter-item "><a href="ch07-02-defining-modules-to-control-scope-and-privacy.html"><strong aria-hidden="true">4.4.1.2.</strong> Defining Modules to Control Scope and Privacy</a></li><li class="chapter-item "><a href="ch07-03-paths-for-referring-to-an-item-in-the-module-tree.html"><strong aria-hidden="true">4.4.1.3.</strong> Paths for Referring to an Item in the Module Tree</a></li><li class="chapter-item "><a href="ch07-04-bringing-paths-into-scope-with-the-use-keyword.html"><strong aria-hidden="true">4.4.1.4.</strong> Bringing Paths Into Scope with the use Keyword</a></li><li class="chapter-item "><a href="ch07-05-separating-modules-into-different-files.html"><strong aria-hidden="true">4.4.1.5.</strong> Separating Modules into Different Files</a></li></ol></li><li class="chapter-item "><a href="ch08-00-common-collections.html"><strong aria-hidden="true">4.4.2.</strong> Common Collections</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch08-01-vectors.html"><strong aria-hidden="true">4.4.2.1.</strong> Vectors: Storing Lists of The Same Type of Values</a></li><li class="chapter-item "><a href="ch08-02-strings.html"><strong aria-hidden="true">4.4.2.2.</strong> Strings: Storing UTF-8 Encoded Text</a></li><li class="chapter-item "><a href="ch08-03-hash-maps.html"><strong aria-hidden="true">4.4.2.3.</strong> HasnMap&lt;K, V&gt;: Storing Keys with Associated Values</a></li></ol></li><li class="chapter-item "><a href="ch09-00-error-handling.html"><strong aria-hidden="true">4.4.3.</strong> Error Handling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch09-01-unrecoverable-errors-with-panic.html"><strong aria-hidden="true">4.4.3.1.</strong> Unrecoverable Errors with panic!</a></li><li class="chapter-item "><a href="ch09-02-recoverable-errors-with-result.html"><strong aria-hidden="true">4.4.3.2.</strong> ⭐️Recoverable Errors with Result</a></li><li class="chapter-item "><a href="ch09-03-to-panic-or-not-to-panic.html"><strong aria-hidden="true">4.4.3.3.</strong> To panic! or Not to panic!</a></li></ol></li><li class="chapter-item "><a href="ch10-00-generics.html"><strong aria-hidden="true">4.4.4.</strong> Generic Types, Traits, and Lifetimes</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch10-01-syntax.html"><strong aria-hidden="true">4.4.4.1.</strong> ✨Generic Data Types</a></li><li class="chapter-item "><a href="ch10-02-traits.html"><strong aria-hidden="true">4.4.4.2.</strong> 🪐Traits: Defining Shared Behavior</a></li><li class="chapter-item "><a href="ch10-03-lifetime-syntax.html"><strong aria-hidden="true">4.4.4.3.</strong> ⭐️Validating References with Lifetimes</a></li></ol></li><li class="chapter-item "><a href="ch11-00-testing.html"><strong aria-hidden="true">4.4.5.</strong> Writing Automated Tests</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch11-01-writing-tests.html"><strong aria-hidden="true">4.4.5.1.</strong> How to Write Tests</a></li><li class="chapter-item "><a href="ch11-02-running-tests.html"><strong aria-hidden="true">4.4.5.2.</strong> Controlling How Tests Are Run</a></li><li class="chapter-item "><a href="ch11-03-test-organization.html"><strong aria-hidden="true">4.4.5.3.</strong> Test Organization</a></li></ol></li><li class="chapter-item "><a href="ch12-00-an-io-project.html"><strong aria-hidden="true">4.4.6.</strong> An I/O Project: Building a Command Line Program</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch12-01-accepting-command-line-arguments.html"><strong aria-hidden="true">4.4.6.1.</strong> Accepting Command Line Arguments</a></li><li class="chapter-item "><a href="ch12-02-reading-a-file.html"><strong aria-hidden="true">4.4.6.2.</strong> Reading a File</a></li><li class="chapter-item "><a href="ch12-03-improving-error-handling-and-modularity.html"><strong aria-hidden="true">4.4.6.3.</strong> Refactoring to Improve Modularity and Error Handling</a></li><li class="chapter-item "><a href="ch12-04-testing-the-librarys-functionality.html"><strong aria-hidden="true">4.4.6.4.</strong> Developing the Library’s Functionality with Test Driven Development</a></li><li class="chapter-item "><a href="ch12-05-working-with-environment-variables.html"><strong aria-hidden="true">4.4.6.5.</strong> Working with Environment Variables</a></li><li class="chapter-item "><a href="ch12-06-writing-to-stderr-instead-of-stdout.html"><strong aria-hidden="true">4.4.6.6.</strong> Writing Error Messages to Standard Error Instead of Standard Output</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="thinking_in_rust.html"><strong aria-hidden="true">4.5.</strong> 🤔Thinking in Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch13-00-functional-features.html"><strong aria-hidden="true">4.5.1.</strong> Functional Language Features: Iterators and Closures</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch13-01-closures.html"><strong aria-hidden="true">4.5.1.1.</strong> Closures: Anonymous Functions that Capture Their Environment</a></li><li class="chapter-item "><a href="ch13-02-iterators.html"><strong aria-hidden="true">4.5.1.2.</strong> Processing a Series of Items with Iterators</a></li><li class="chapter-item "><a href="ch13-03-improving-our-io-project.html"><strong aria-hidden="true">4.5.1.3.</strong> Improving Our I/O Project</a></li><li class="chapter-item "><a href="ch13-04-performance.html"><strong aria-hidden="true">4.5.1.4.</strong> Comparing Performance: Loops vs. Iterators</a></li></ol></li><li class="chapter-item "><a href="ch14-00-more-about-cargo.html"><strong aria-hidden="true">4.5.2.</strong> More about Cargo and Crates.io</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch14-01-release-profiles.html"><strong aria-hidden="true">4.5.2.1.</strong> Customizing Builds with Release Profiles</a></li><li class="chapter-item "><a href="ch14-02-publishing-to-crates-io.html"><strong aria-hidden="true">4.5.2.2.</strong> Publishing a Crate to Crates.io</a></li><li class="chapter-item "><a href="ch14-03-cargo-workspaces.html"><strong aria-hidden="true">4.5.2.3.</strong> Cargo Workspaces</a></li><li class="chapter-item "><a href="ch14-04-installing-binaries.html"><strong aria-hidden="true">4.5.2.4.</strong> Installing Binaries from Crates.io with cargo install</a></li><li class="chapter-item "><a href="ch14-05-extending-cargo.html"><strong aria-hidden="true">4.5.2.5.</strong> Extending Cargo with Custom Commands</a></li></ol></li><li class="chapter-item expanded "><a href="ch15-00-smart-pointers.html"><strong aria-hidden="true">4.5.3.</strong> ✨Smart Pointers: Heap、Deref、Drop、Rc、RefCell、Reference Cycle</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch15-01-box.html"><strong aria-hidden="true">4.5.3.1.</strong> Heap: Using Box&lt;T&gt; to Point to Data on the Heap</a></li><li class="chapter-item "><a href="ch15-02-deref.html"><strong aria-hidden="true">4.5.3.2.</strong> Deref: Treating Smart Pointers Like Regular References with the Deref Trait</a></li><li class="chapter-item "><a href="ch15-03-drop.html"><strong aria-hidden="true">4.5.3.3.</strong> Drop: Running Code on Cleanup with the Drop Trait</a></li><li class="chapter-item "><a href="ch15-04-rc.html"><strong aria-hidden="true">4.5.3.4.</strong> Rc&lt;T&gt;: immutable references of multiple owners, the Reference Counted Smart Pointer</a></li><li class="chapter-item expanded "><a href="ch15-05-interior-mutability.html" class="active"><strong aria-hidden="true">4.5.3.5.</strong> RefCell&lt;T&gt; and the Interior Mutability Pattern</a></li><li class="chapter-item "><a href="ch15-06-reference-cycles.html"><strong aria-hidden="true">4.5.3.6.</strong> Reference Cycles Can Leak Memory</a></li></ol></li><li class="chapter-item "><a href="ch16-00-concurrency.html"><strong aria-hidden="true">4.5.4.</strong> Fearless Concurrency</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch16-01-threads.html"><strong aria-hidden="true">4.5.4.1.</strong> Using Threads to Run Code Simultaneously</a></li><li class="chapter-item "><a href="ch16-02-message-passing.html"><strong aria-hidden="true">4.5.4.2.</strong> Using Message Passing to Transfer Data Between Threads</a></li><li class="chapter-item "><a href="ch16-03-shared-state.html"><strong aria-hidden="true">4.5.4.3.</strong> Shared-State Concurrency</a></li><li class="chapter-item "><a href="ch16-04-extensible-concurrency-sync-and-send.html"><strong aria-hidden="true">4.5.4.4.</strong> Extensible Concurrency with the Sync and Send Traits</a></li></ol></li><li class="chapter-item "><a href="ch17-00-oop.html"><strong aria-hidden="true">4.5.5.</strong> Object Oriented Programming Features of Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch17-01-what-is-oo.html"><strong aria-hidden="true">4.5.5.1.</strong> Characteristics of Object-Oriented Languages</a></li><li class="chapter-item "><a href="ch17-02-trait-objects.html"><strong aria-hidden="true">4.5.5.2.</strong> 🌛️Using Trait Objects That Allow for Values of Different Types</a></li><li class="chapter-item "><a href="ch17-03-oo-design-patterns.html"><strong aria-hidden="true">4.5.5.3.</strong> Implementing an Object-Oriented Design Pattern</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">4.6.</strong> Advanced Topics</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch18-00-patterns.html"><strong aria-hidden="true">4.6.1.</strong> Patterns and Matching</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch18-01-all-the-places-for-patterns.html"><strong aria-hidden="true">4.6.1.1.</strong> All the Places Patterns Can Be Used</a></li><li class="chapter-item "><a href="ch18-02-refutability.html"><strong aria-hidden="true">4.6.1.2.</strong> Refutability: Whether a Pattern Might Fail to Match</a></li><li class="chapter-item "><a href="ch18-03-pattern-syntax.html"><strong aria-hidden="true">4.6.1.3.</strong> ⭐️Pattern Syntax</a></li></ol></li><li class="chapter-item "><a href="ch19-00-advanced-features.html"><strong aria-hidden="true">4.6.2.</strong> Advanced Features</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch19-01-unsafe-rust.html"><strong aria-hidden="true">4.6.2.1.</strong> Unsafe Rust</a></li><li class="chapter-item "><a href="ch19-03-advanced-traits.html"><strong aria-hidden="true">4.6.2.2.</strong> ⭐️Advanced Traits</a></li><li class="chapter-item "><a href="ch19-04-advanced-types.html"><strong aria-hidden="true">4.6.2.3.</strong> ✨Advanced Types</a></li><li class="chapter-item "><a href="ch19-05-advanced-functions-and-closures.html"><strong aria-hidden="true">4.6.2.4.</strong> 📦Advanced Functions and Closures</a></li><li class="chapter-item "><a href="ch19-06-macros.html"><strong aria-hidden="true">4.6.2.5.</strong> Macros</a></li></ol></li><li class="chapter-item "><a href="ch20-00-final-project-a-web-server.html"><strong aria-hidden="true">4.6.3.</strong> Final Project: Building a Multithreaded Web Server</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ch20-01-single-threaded.html"><strong aria-hidden="true">4.6.3.1.</strong> Building a Single-Threaded Web Server</a></li><li class="chapter-item "><a href="ch20-02-multithreaded.html"><strong aria-hidden="true">4.6.3.2.</strong> Turning Our Single-Threaded Server into a Multithreaded Server</a></li><li class="chapter-item "><a href="ch20-03-graceful-shutdown-and-cleanup.html"><strong aria-hidden="true">4.6.3.3.</strong> Graceful Shutdown and Cleanup</a></li></ol></li><li class="chapter-item "><a href="appendix-00.html"><strong aria-hidden="true">4.6.4.</strong> Appendix</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="appendix-01-keywords.html"><strong aria-hidden="true">4.6.4.1.</strong> A - Keywords</a></li><li class="chapter-item "><a href="appendix-02-operators.html"><strong aria-hidden="true">4.6.4.2.</strong> B - Operators and Symbols</a></li><li class="chapter-item "><a href="appendix-03-derivable-traits.html"><strong aria-hidden="true">4.6.4.3.</strong> ✨️C - Derivable Traits</a></li><li class="chapter-item "><a href="appendix-04-useful-development-tools.html"><strong aria-hidden="true">4.6.4.4.</strong> D - Useful Development Tools</a></li><li class="chapter-item "><a href="appendix-05-editions.html"><strong aria-hidden="true">4.6.4.5.</strong> E - Editions</a></li><li class="chapter-item "><a href="appendix-06-translation.html"><strong aria-hidden="true">4.6.4.6.</strong> F - Translations of the Book</a></li><li class="chapter-item "><a href="appendix-07-nightly-rust.html"><strong aria-hidden="true">4.6.4.7.</strong> G - How Rust is Made and “Nightly Rust”</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="rust_by_example_src/index.html"><strong aria-hidden="true">5.</strong> Rust By Examples</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/hello.html"><strong aria-hidden="true">5.1.</strong> Hello World</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/hello/comment.html"><strong aria-hidden="true">5.1.1.</strong> Comments</a></li><li class="chapter-item "><a href="rust_by_example_src/hello/print.html"><strong aria-hidden="true">5.1.2.</strong> Formatted print</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/hello/print/print_debug.html"><strong aria-hidden="true">5.1.2.1.</strong> Debug</a></li><li class="chapter-item "><a href="rust_by_example_src/hello/print/print_display.html"><strong aria-hidden="true">5.1.2.2.</strong> Display</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/hello/print/print_display/testcase_list.html"><strong aria-hidden="true">5.1.2.2.1.</strong> Testcase: List</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/hello/print/fmt.html"><strong aria-hidden="true">5.1.2.3.</strong> Formatting</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Types: Primitives, custom Types, Bindings and Change/Define/Advanced Conversion</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/primitives.html"><strong aria-hidden="true">5.2.1.</strong> Primitives</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/primitives/literals.html"><strong aria-hidden="true">5.2.1.1.</strong> Literals and operators</a></li><li class="chapter-item "><a href="rust_by_example_src/primitives/tuples.html"><strong aria-hidden="true">5.2.1.2.</strong> Tuples: a collection of values of different types</a></li><li class="chapter-item "><a href="rust_by_example_src/primitives/array.html"><strong aria-hidden="true">5.2.1.3.</strong> Arrays and Slices: a collection of objects of the same type T</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/custom_types.html"><strong aria-hidden="true">5.2.2.</strong> Custom Types: struct and enum</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/custom_types/structs.html"><strong aria-hidden="true">5.2.2.1.</strong> Structures: Tuple, C structs and Unit structs</a></li><li class="chapter-item "><a href="rust_by_example_src/custom_types/enum.html"><strong aria-hidden="true">5.2.2.2.</strong> ✨Enums: and Type alias</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/custom_types/enum/enum_use.html"><strong aria-hidden="true">5.2.2.2.1.</strong> use</a></li><li class="chapter-item "><a href="rust_by_example_src/custom_types/enum/c_like.html"><strong aria-hidden="true">5.2.2.2.2.</strong> C-like</a></li><li class="chapter-item "><a href="rust_by_example_src/custom_types/enum/testcase_linked_list.html"><strong aria-hidden="true">5.2.2.2.3.</strong> Testcase: linked-list</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/custom_types/constants.html"><strong aria-hidden="true">5.2.2.3.</strong> constants: const and static</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/variable_bindings.html"><strong aria-hidden="true">5.2.3.</strong> Variable Bindings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/variable_bindings/mut.html"><strong aria-hidden="true">5.2.3.1.</strong> Mutability</a></li><li class="chapter-item "><a href="rust_by_example_src/variable_bindings/scope.html"><strong aria-hidden="true">5.2.3.2.</strong> Scope ({}) and Shadowing</a></li><li class="chapter-item "><a href="rust_by_example_src/variable_bindings/declare.html"><strong aria-hidden="true">5.2.3.3.</strong> Declare first</a></li><li class="chapter-item "><a href="rust_by_example_src/variable_bindings/freeze.html"><strong aria-hidden="true">5.2.3.4.</strong> Freezing</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/types.html"><strong aria-hidden="true">5.2.4.</strong> 🚶Basic Conversion: Change or Define Types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/types/cast.html"><strong aria-hidden="true">5.2.4.1.</strong> as: Casting using as keyword</a></li><li class="chapter-item "><a href="rust_by_example_src/types/literals.html"><strong aria-hidden="true">5.2.4.2.</strong> Literals</a></li><li class="chapter-item "><a href="rust_by_example_src/types/inference.html"><strong aria-hidden="true">5.2.4.3.</strong> Inference</a></li><li class="chapter-item "><a href="rust_by_example_src/types/alias.html"><strong aria-hidden="true">5.2.4.4.</strong> ✨Type Aliasing: give a new name to an existing type</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/conversion.html"><strong aria-hidden="true">5.2.5.</strong> 💃Advanced Conversion: From/Into trait</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/conversion/from_into.html"><strong aria-hidden="true">5.2.5.1.</strong> From and Into</a></li><li class="chapter-item "><a href="rust_by_example_src/conversion/try_from_try_into.html"><strong aria-hidden="true">5.2.5.2.</strong> TryFrom and TryInto: used for fallible conversions, return Result</a></li><li class="chapter-item "><a href="rust_by_example_src/conversion/string.html"><strong aria-hidden="true">5.2.5.3.</strong> ToString and FromStr trait: To and from Strings</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.3.</strong> Control: Statements, Functions and Error handling</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/expression.html"><strong aria-hidden="true">5.3.1.</strong> ✨Expressions: statements end with ;</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control.html"><strong aria-hidden="true">5.3.2.</strong> 🧮 Flow of Control</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/flow_control/if_else.html"><strong aria-hidden="true">5.3.2.1.</strong> if/else</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/loop.html"><strong aria-hidden="true">5.3.2.2.</strong> loop</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/flow_control/loop/nested.html"><strong aria-hidden="true">5.3.2.2.1.</strong> Nesting and labels: a little like lifetime annotations</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/loop/return.html"><strong aria-hidden="true">5.3.2.2.2.</strong> Returning from loops</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/while.html"><strong aria-hidden="true">5.3.2.3.</strong> while</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/while_let.html"><strong aria-hidden="true">5.3.2.4.</strong> ✨while_let</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/for.html"><strong aria-hidden="true">5.3.2.5.</strong> for and range</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/match.html"><strong aria-hidden="true">5.3.2.6.</strong> ⭐️match</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/flow_control/match/destructuring.html"><strong aria-hidden="true">5.3.2.6.1.</strong> ✨✨✨Destructuring</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/match/guard.html"><strong aria-hidden="true">5.3.2.6.2.</strong> Guards: to filter the arm</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/match/binding.html"><strong aria-hidden="true">5.3.2.6.3.</strong> @ Binding</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/if_let.html"><strong aria-hidden="true">5.3.2.7.</strong> if let</a></li><li class="chapter-item "><a href="rust_by_example_src/flow_control/while_let.html"><strong aria-hidden="true">5.3.2.8.</strong> while let</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/fn.html"><strong aria-hidden="true">5.3.3.</strong> ✨Functions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/fn/methods.html"><strong aria-hidden="true">5.3.3.1.</strong> Methods</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures.html"><strong aria-hidden="true">5.3.3.2.</strong> ✨Closures</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/fn/closures/capture.html"><strong aria-hidden="true">5.3.3.2.1.</strong> Capturing</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.3.3.2.2.</strong> Fn/FnMut/FnOnce</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/fn/closures/anonymity.html"><strong aria-hidden="true">5.3.3.2.2.1.</strong> Type anonymity</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures/input_parameters.html"><strong aria-hidden="true">5.3.3.2.2.2.</strong> As input parameters</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures/output_parameters.html"><strong aria-hidden="true">5.3.3.2.2.3.</strong> As output parameters</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures/input_functions.html"><strong aria-hidden="true">5.3.3.2.2.4.</strong> Input functions</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures/closure_examples.html"><strong aria-hidden="true">5.3.3.2.3.</strong> Examples in std</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/fn/closures/closure_examples/iter_any.html"><strong aria-hidden="true">5.3.3.2.3.1.</strong> Iterator::any</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/closures/closure_examples/iter_find.html"><strong aria-hidden="true">5.3.3.2.3.2.</strong> Searching through iterators</a></li></ol></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/fn/hof.html"><strong aria-hidden="true">5.3.3.3.</strong> Higher Order Functions</a></li><li class="chapter-item "><a href="rust_by_example_src/fn/diverging.html"><strong aria-hidden="true">5.3.3.4.</strong> ✨Diverging functions: return !, different from ()</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/error.html"><strong aria-hidden="true">5.3.4.</strong> ⭐️Error handling: Panic、Option and Result</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/panic.html"><strong aria-hidden="true">5.3.4.1.</strong> panic!: unrecoverable, try-exception</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/abort_unwind.html"><strong aria-hidden="true">5.3.4.1.1.</strong> ✨abort & unwind: Two implementation mechanisms of panic</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/error/option_unwrap.html"><strong aria-hidden="true">5.3.4.2.</strong> Option & unwrap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/option_unwrap/map.html"><strong aria-hidden="true">5.3.4.2.1.</strong> Combinators of Option: map</a></li><li class="chapter-item "><a href="rust_by_example_src/error/option_unwrap/and_then.html"><strong aria-hidden="true">5.3.4.2.2.</strong> Combinators of Option: and_then</a></li><li class="chapter-item "><a href="rust_by_example_src/error/option_unwrap/defaults.html"><strong aria-hidden="true">5.3.4.2.3.</strong> Defaults: or, or_else, get_or_insert, 'get_or_insert_with`</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/error/result.html"><strong aria-hidden="true">5.3.4.3.</strong> Result & OK or ?: A Richer Version Of Option</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/result/result_map.html"><strong aria-hidden="true">5.3.4.3.1.</strong> map for Result: catch explicit Exception and Continue</a></li><li class="chapter-item "><a href="rust_by_example_src/error/result/result_alias.html"><strong aria-hidden="true">5.3.4.3.2.</strong> Custom Exception: aliases for Result</a></li><li class="chapter-item "><a href="rust_by_example_src/error/result/early_returns.html"><strong aria-hidden="true">5.3.4.3.3.</strong> Early returns: Catch Exception and Return</a></li></ol></li><li class="chapter-item "><a href="#.html"><strong aria-hidden="true">5.3.4.4.</strong> ?: the uses of question mark</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/result/enter_question_mark.html"><strong aria-hidden="true">5.3.4.4.1.</strong> Introducing ?</a></li><li class="chapter-item "><a href="rust_by_example_src/error/option_unwrap/question_mark.html"><strong aria-hidden="true">5.3.4.4.2.</strong> Unpacking options with ? to return the Some or terminate</a></li><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types/reenter_question_mark.html"><strong aria-hidden="true">5.3.4.4.3.</strong> Other uses of ?</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types.html"><strong aria-hidden="true">5.3.4.5.</strong> Multiple error types to interact</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types/option_result.html"><strong aria-hidden="true">5.3.4.5.1.</strong> Pulling Results out of Options</a></li><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types/define_error_type.html"><strong aria-hidden="true">5.3.4.5.2.</strong> Defining an error type</a></li><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types/boxing_errors.html"><strong aria-hidden="true">5.3.4.5.3.</strong> Boxing errors</a></li><li class="chapter-item "><a href="rust_by_example_src/error/multiple_error_types/wrap_error.html"><strong aria-hidden="true">5.3.4.5.4.</strong> Wrapping errors</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/error/iter_result.html"><strong aria-hidden="true">5.3.4.6.</strong> Iterating over Results</a></li><li class="chapter-item "><a href="rust_by_example_src/encapsulation_modules_crates_cargo.html"><strong aria-hidden="true">5.3.4.7.</strong> 📒Error Handling Practices -- ChatGPT</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/error/error_handling_practices/basic_practics.html"><strong aria-hidden="true">5.3.4.7.1.</strong> Basic Practices</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/encapsulation_modules_crates_cargo.html"><strong aria-hidden="true">5.4.</strong> Encapsulation: Modules, Crates and Cargo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/mod.html"><strong aria-hidden="true">5.4.1.</strong> Modules: hierarchically split and manage visibility</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/mod/visibility.html"><strong aria-hidden="true">5.4.1.1.</strong> Visibility</a></li><li class="chapter-item "><a href="rust_by_example_src/mod/struct_visibility.html"><strong aria-hidden="true">5.4.1.2.</strong> Struct visibility: an extra level of visibility with their fields</a></li><li class="chapter-item "><a href="rust_by_example_src/mod/use.html"><strong aria-hidden="true">5.4.1.3.</strong> The use declaration: bind a full path to a new name</a></li><li class="chapter-item "><a href="rust_by_example_src/mod/super.html"><strong aria-hidden="true">5.4.1.4.</strong> super and self: remove ambiguity</a></li><li class="chapter-item "><a href="rust_by_example_src/mod/split.html"><strong aria-hidden="true">5.4.1.5.</strong> File/Directory hierarchy</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/crates.html"><strong aria-hidden="true">5.4.2.</strong> Crates: compilation units in Rust, library or binary</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/crates/lib.html"><strong aria-hidden="true">5.4.2.1.</strong> Creating a Library: --crate-type=lib</a></li><li class="chapter-item "><a href="rust_by_example_src/crates/using_lib.html"><strong aria-hidden="true">5.4.2.2.</strong> Using a Library: --extern</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/cargo.html"><strong aria-hidden="true">5.4.3.</strong> Cargo: package management tool</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/cargo/deps.html"><strong aria-hidden="true">5.4.3.1.</strong> Dependencies</a></li><li class="chapter-item "><a href="rust_by_example_src/cargo/conventions.html"><strong aria-hidden="true">5.4.3.2.</strong> Two Binaries Conventions</a></li><li class="chapter-item "><a href="rust_by_example_src/cargo/test.html"><strong aria-hidden="true">5.4.3.3.</strong> ✨Tests</a></li><li class="chapter-item "><a href="rust_by_example_src/cargo/build_scripts.html"><strong aria-hidden="true">5.4.3.4.</strong> Build Scripts</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.5.</strong> Rust Core: Generics, Traits and Scoping</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics.html"><strong aria-hidden="true">5.5.1.</strong> 🪐Generics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/used_as_parameter.html"><strong aria-hidden="true">5.5.1.1.</strong> Used as Parameter</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/gen_fn.html"><strong aria-hidden="true">5.5.1.1.1.</strong> Functions: Identify whether a generic function</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/impl.html"><strong aria-hidden="true">5.5.1.1.2.</strong> Impl Type fn: Identify whether a generic method</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/gen_trait.html"><strong aria-hidden="true">5.5.1.1.3.</strong> Impl Traits fn: Identify whether a generic method</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/generics/trait_bounds.html"><strong aria-hidden="true">5.5.1.2.</strong> Bounded by Trait</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/bounds/testcase_empty.html"><strong aria-hidden="true">5.5.1.2.1.</strong> ✨Testcase: empty bounds</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/bounds/multi_trait_bounds.html"><strong aria-hidden="true">5.5.1.2.2.</strong> Multiple Trait Bounds</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/bounds/where_bounds.html"><strong aria-hidden="true">5.5.1.2.3.</strong> Where clauses bounds</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/generics/new_types.html"><strong aria-hidden="true">5.5.1.3.</strong> New Type Idiom</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/assoc_items.html"><strong aria-hidden="true">5.5.1.4.</strong> ✨Associated items</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/assoc_items/the_problem.html"><strong aria-hidden="true">5.5.1.4.1.</strong> ✨The Problem</a></li><li class="chapter-item "><a href="rust_by_example_src/generics/assoc_items/types.html"><strong aria-hidden="true">5.5.1.4.2.</strong> Associated types</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/generics/phantom.html"><strong aria-hidden="true">5.5.1.5.</strong> Phantom type parameters</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/generics/phantom/testcase_units.html"><strong aria-hidden="true">5.5.1.5.1.</strong> Testcase: unit clarification</a></li></ol></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/trait.html"><strong aria-hidden="true">5.5.2.</strong> 🪐Traits</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/trait/derive.html"><strong aria-hidden="true">5.5.2.1.</strong> ✨Derive Macro Traits</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/dyn.html"><strong aria-hidden="true">5.5.2.2.</strong> Returning Traits with dyn</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/ops.html"><strong aria-hidden="true">5.5.2.3.</strong> Operator Overloading</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/drop.html"><strong aria-hidden="true">5.5.2.4.</strong> Drop</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/iter.html"><strong aria-hidden="true">5.5.2.5.</strong> Iterators: Iterator Trait</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/impl_trait.html"><strong aria-hidden="true">5.5.2.6.</strong> ✨impl Trait</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/supertraits.html"><strong aria-hidden="true">5.5.2.7.</strong> Supertraits</a></li><li class="chapter-item "><a href="rust_by_example_src/trait/disambiguating.html"><strong aria-hidden="true">5.5.2.8.</strong> Fully Qualified Syntax: Disambiguating overlapping traits</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/scope.html"><strong aria-hidden="true">5.5.3.</strong> 🪐Scoping rules</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/scope/raii.html"><strong aria-hidden="true">5.5.3.1.</strong> RAII</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/move.html"><strong aria-hidden="true">5.5.3.2.</strong> Ownership and moves</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/scope/move/mut.html"><strong aria-hidden="true">5.5.3.2.1.</strong> Mutability</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/move/partial_move.html"><strong aria-hidden="true">5.5.3.2.2.</strong> Partial moves</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/scope/borrow.html"><strong aria-hidden="true">5.5.3.3.</strong> Borrowing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/scope/borrow/mut.html"><strong aria-hidden="true">5.5.3.3.1.</strong> Mutability</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/borrow/alias.html"><strong aria-hidden="true">5.5.3.3.2.</strong> Mutable or Immutable, Only One</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/borrow/ref.html"><strong aria-hidden="true">5.5.3.3.3.</strong> ✨The ref pattern</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime.html"><strong aria-hidden="true">5.5.3.4.</strong> Lifetimes</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/elision.html"><strong aria-hidden="true">5.5.3.4.1.</strong> Elision</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/explicit.html"><strong aria-hidden="true">5.5.3.4.2.</strong> ✨Explicit lifetime annotation: another Generic</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/fn_method_struct_trait.html"><strong aria-hidden="true">5.5.3.4.3.</strong> ✨Functions、methods、struct、trait</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/lifetime_bounds.html"><strong aria-hidden="true">5.5.3.4.4.</strong> Lifetime Bounds for generics</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/lifetime_coercion.html"><strong aria-hidden="true">5.5.3.4.5.</strong> Coercion</a></li><li class="chapter-item "><a href="rust_by_example_src/scope/lifetime/static_lifetime.html"><strong aria-hidden="true">5.5.3.4.6.</strong> Static</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.6.</strong> Macros: rules! and Attributes</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/macros.html"><strong aria-hidden="true">5.6.1.</strong> macro_rules!</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/macros/syntax.html"><strong aria-hidden="true">5.6.1.1.</strong> Syntax</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/macros/designators.html"><strong aria-hidden="true">5.6.1.1.1.</strong> Designators</a></li><li class="chapter-item "><a href="rust_by_example_src/macros/overload.html"><strong aria-hidden="true">5.6.1.1.2.</strong> Overload</a></li><li class="chapter-item "><a href="rust_by_example_src/macros/repeat.html"><strong aria-hidden="true">5.6.1.1.3.</strong> Repeat</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/macros/dry.html"><strong aria-hidden="true">5.6.1.2.</strong> DRY (rust_by_example_src/Don't Repeat Yourself)</a></li><li class="chapter-item "><a href="rust_by_example_src/macros/dsl.html"><strong aria-hidden="true">5.6.1.3.</strong> DSL (rust_by_example_src/Domain Specific Languages)</a></li><li class="chapter-item "><a href="rust_by_example_src/macros/variadics.html"><strong aria-hidden="true">5.6.1.4.</strong> Variadics</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/attribute.html"><strong aria-hidden="true">5.6.2.</strong> 🧐 Attributes: metadata applied to some module, crate or item</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/attribute/unused.html"><strong aria-hidden="true">5.6.2.1.</strong> dead_code: disable the unused lint</a></li><li class="chapter-item "><a href="rust_by_example_src/attribute/crate.html"><strong aria-hidden="true">5.6.2.2.</strong> Crates: : crate_type and crate_name</a></li><li class="chapter-item "><a href="rust_by_example_src/attribute/cfg.html"><strong aria-hidden="true">5.6.2.3.</strong> cfg: Configuration conditional checks</a></li><li class="chapter-item "><a href="rust_by_example_src/attribute/cfg/custom.html"><strong aria-hidden="true">5.6.2.4.</strong> Custom: Custom conditionals</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.7.</strong> Std: Library types and Misc</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std.html"><strong aria-hidden="true">5.7.1.</strong> ⭐️Std library types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std/box.html"><strong aria-hidden="true">5.7.1.1.</strong> ✨Box, stack and heap</a></li><li class="chapter-item "><a href="rust_by_example_src/std/vec.html"><strong aria-hidden="true">5.7.1.2.</strong> ✨Vectors: re-sizable arrays</a></li><li class="chapter-item "><a href="rust_by_example_src/std/str.html"><strong aria-hidden="true">5.7.1.3.</strong> ✨Strings: String and &str</a></li><li class="chapter-item "><a href="rust_by_example_src/std/panic.html"><strong aria-hidden="true">5.7.1.4.</strong> panic!: Raise Exception , no Catch</a></li><li class="chapter-item "><a href="rust_by_example_src/std/option.html"><strong aria-hidden="true">5.7.1.5.</strong> Option: catching failure instead of calling panic!</a></li><li class="chapter-item "><a href="rust_by_example_src/std/result.html"><strong aria-hidden="true">5.7.1.6.</strong> Result: express why an operation failed</a></li><li class="chapter-item "><a href="rust_by_example_src/std/result/question_mark.html"><strong aria-hidden="true">5.7.1.7.</strong> ?: Chaining Results only match Ok(ok)</a></li><li class="chapter-item "><a href="rust_by_example_src/std/hash.html"><strong aria-hidden="true">5.7.1.8.</strong> HashMap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std/hash/alt_key_types.html"><strong aria-hidden="true">5.7.1.8.1.</strong> Alternate/custom key types</a></li><li class="chapter-item "><a href="rust_by_example_src/std/hash/hashset.html"><strong aria-hidden="true">5.7.1.8.2.</strong> HashSet</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/std/rc.html"><strong aria-hidden="true">5.7.1.9.</strong> Rc: for mutiple ownership, just like what python have done</a></li><li class="chapter-item "><a href="rust_by_example_src/std/arc.html"><strong aria-hidden="true">5.7.1.10.</strong> Arc: shared ownership between threads</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/std_misc.html"><strong aria-hidden="true">5.7.2.</strong> 🌌 Std misc</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std_misc/threads.html"><strong aria-hidden="true">5.7.2.1.</strong> Threads</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/threads/testcase_mapreduce.html"><strong aria-hidden="true">5.7.2.2.</strong> ✨Testcase: map-reduce</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/channels.html"><strong aria-hidden="true">5.7.2.3.</strong> Channels: Asynchronous communication between threads</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/path.html"><strong aria-hidden="true">5.7.2.4.</strong> Path</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/file.html"><strong aria-hidden="true">5.7.2.5.</strong> File I/O</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std_misc/file/open.html"><strong aria-hidden="true">5.7.2.5.1.</strong> open: read-only</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/file/create.html"><strong aria-hidden="true">5.7.2.5.2.</strong> create: write-only</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/file/read_lines.html"><strong aria-hidden="true">5.7.2.5.3.</strong> read lines: returns an iterator</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/process.html"><strong aria-hidden="true">5.7.2.6.</strong> Child processes</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std_misc/process/pipe.html"><strong aria-hidden="true">5.7.2.6.1.</strong> Pipes: interaction with the underlying process</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/process/wait.html"><strong aria-hidden="true">5.7.2.6.2.</strong> Wait</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/fs.html"><strong aria-hidden="true">5.7.2.7.</strong> std::fs: Filesystem Operations</a></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/arg.html"><strong aria-hidden="true">5.7.2.8.</strong> Program arguments</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/std_misc/arg/matching.html"><strong aria-hidden="true">5.7.2.8.1.</strong> Match to Argument parsing</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/std_misc/ffi.html"><strong aria-hidden="true">5.7.2.9.</strong> FFI: Foreign Function Interface</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.8.</strong> Misc: Testing, Unsafe, Compatibility and Meta</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/testing.html"><strong aria-hidden="true">5.8.1.</strong> Testing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/testing/unit_testing.html"><strong aria-hidden="true">5.8.1.1.</strong> ✨Unit testing for panic: #[cfg(test)], #[test], #[should_panic], #[ignore]</a></li><li class="chapter-item "><a href="rust_by_example_src/meta/doc.html"><strong aria-hidden="true">5.8.1.2.</strong> Documentation: cargo doc</a></li><li class="chapter-item "><a href="rust_by_example_src/testing/doc_testing.html"><strong aria-hidden="true">5.8.1.3.</strong> ⭐️Documentation testing</a></li><li class="chapter-item "><a href="rust_by_example_src/testing/integration_testing.html"><strong aria-hidden="true">5.8.1.4.</strong> Integration testing</a></li><li class="chapter-item "><a href="rust_by_example_src/testing/dev_dependencies.html"><strong aria-hidden="true">5.8.1.5.</strong> Dev-dependencies</a></li></ol></li><li class="chapter-item "><a href="rust_by_example_src/unsafe.html"><strong aria-hidden="true">5.8.2.</strong> Unsafe Operations</a></li><li class="chapter-item "><a href="rust_by_example_src/unsafe/asm.html"><strong aria-hidden="true">5.8.3.</strong> 🤔️asm!: Inline assembly in Unsafe</a></li><li class="chapter-item "><a href="rust_by_example_src/compatibility.html"><strong aria-hidden="true">5.8.4.</strong> Compatibility</a></li><li class="chapter-item "><a href="rust_by_example_src/compatibility/raw_identifiers.html"><strong aria-hidden="true">5.8.5.</strong> Raw identifiers: r#</a></li><li class="chapter-item "><a href="rust_by_example_src/meta.html"><strong aria-hidden="true">5.8.6.</strong> Meta</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust_by_example_src/meta/playground.html"><strong aria-hidden="true">5.8.6.1.</strong> Playground</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="PyO3_guides/src/index.html"><strong aria-hidden="true">6.</strong> The PyO3 Guide</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/getting_started.html"><strong aria-hidden="true">6.1.</strong> Getting started</a></li><li class="chapter-item "><a href="PyO3_guides/src/module.html"><strong aria-hidden="true">6.2.</strong> Python modules</a></li><li class="chapter-item "><a href="PyO3_guides/src/function.html"><strong aria-hidden="true">6.3.</strong> Python functions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/function/signature.html"><strong aria-hidden="true">6.3.1.</strong> Function signatures</a></li><li class="chapter-item "><a href="PyO3_guides/src/function/error_handling.html"><strong aria-hidden="true">6.3.2.</strong> Error handling</a></li></ol></li><li class="chapter-item "><a href="PyO3_guides/src/class.html"><strong aria-hidden="true">6.4.</strong> Python classes</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/class/protocols.html"><strong aria-hidden="true">6.4.1.</strong> Class customizations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/class/object.html"><strong aria-hidden="true">6.4.1.1.</strong> Basic object customization</a></li><li class="chapter-item "><a href="PyO3_guides/src/class/numeric.html"><strong aria-hidden="true">6.4.1.2.</strong> Emulating numeric types</a></li><li class="chapter-item "><a href="PyO3_guides/src/class/call.html"><strong aria-hidden="true">6.4.1.3.</strong> Emulating callable objects</a></li></ol></li></ol></li><li class="chapter-item "><a href="PyO3_guides/src/conversions.html"><strong aria-hidden="true">6.5.</strong> Type conversions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/conversions/tables.html"><strong aria-hidden="true">6.5.1.</strong> Mapping of Rust types to Python types</a></li><li class="chapter-item "><a href="PyO3_guides/src/conversions/traits.html"><strong aria-hidden="true">6.5.2.</strong> Conversion traits</a></li></ol></li><li class="chapter-item "><a href="PyO3_guides/src/exception.html"><strong aria-hidden="true">6.6.</strong> Python exceptions</a></li><li class="chapter-item "><a href="PyO3_guides/src/python_from_rust.html"><strong aria-hidden="true">6.7.</strong> Calling Python from Rust</a></li><li class="chapter-item "><a href="PyO3_guides/src/types.html"><strong aria-hidden="true">6.8.</strong> GIL, mutability and object types</a></li><li class="chapter-item "><a href="PyO3_guides/src/parallelism.html"><strong aria-hidden="true">6.9.</strong> Parallelism</a></li><li class="chapter-item "><a href="PyO3_guides/src/debugging.html"><strong aria-hidden="true">6.10.</strong> Debugging</a></li><li class="chapter-item "><a href="PyO3_guides/src/features.html"><strong aria-hidden="true">6.11.</strong> Features reference</a></li><li class="chapter-item "><a href="PyO3_guides/src/memory.html"><strong aria-hidden="true">6.12.</strong> Memory management</a></li><li class="chapter-item "><a href="PyO3_guides/src/advanced.html"><strong aria-hidden="true">6.13.</strong> Advanced topics</a></li><li class="chapter-item "><a href="PyO3_guides/src/building_and_distribution.html"><strong aria-hidden="true">6.14.</strong> ⭐️Building and distribution</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/building_and_distribution/multiple_python_versions.html"><strong aria-hidden="true">6.14.1.</strong> Supporting multiple Python versions</a></li></ol></li><li class="chapter-item "><a href="PyO3_guides/src/ecosystem.html"><strong aria-hidden="true">6.15.</strong> Useful crates</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="PyO3_guides/src/ecosystem/logging.html"><strong aria-hidden="true">6.15.1.</strong> Logging</a></li><li class="chapter-item "><a href="PyO3_guides/src/ecosystem/async-await.html"><strong aria-hidden="true">6.15.2.</strong> Using async and await</a></li></ol></li><li class="chapter-item "><a href="PyO3_guides/src/faq.html"><strong aria-hidden="true">6.16.</strong> FAQ and troubleshooting</a></li><li class="chapter-item "><a href="PyO3_guides/src/migration.html"><strong aria-hidden="true">6.17.</strong> Appendix A: Migration guide</a></li><li class="chapter-item "><a href="PyO3_guides/src/rust_cpython.html"><strong aria-hidden="true">6.18.</strong> Appendix B: PyO3 and rust-cpython</a></li><li class="chapter-item "><a href="PyO3_guides/src/trait_bounds.html"><strong aria-hidden="true">6.19.</strong> Appendix C: Trait bounds</a></li><li class="chapter-item "><a href="PyO3_guides/src/python_typing_hints.html"><strong aria-hidden="true">6.20.</strong> Appendix D: Python typing hints</a></li><li class="chapter-item "><a href="PyO3_guides/src/changelog.html"><strong aria-hidden="true">6.21.</strong> CHANGELOG</a></li><li class="chapter-item "><a href="PyO3_guides/src/contributing.html"><strong aria-hidden="true">6.22.</strong> Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">The Rust Programming Language</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">保持批判，有所取舍，知行合一, 方见真我</a> -- 练武不练功
                到头一场空 -- 《赛博英雄传》 </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/rust-lang/book" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="refcellt-and-the-interior-mutability-pattern"><a class="header" href="#refcellt-and-the-interior-mutability-pattern"><code>RefCell&lt;T&gt;</code> and the Interior Mutability Pattern</a></h1>
<!--ts-->
<ul>
<li><a href="#interior-mutability">Interior Mutability</a></li>
<li><a href="#enforcing-borrowing-rules-at-runtime-with-refcellt">Enforcing Borrowing Rules at Runtime with RefCell&lt;T&gt;</a>
<ul>
<li><a href="#the-reasons-to-choose-boxt-rct-or-refcellt">the reasons to choose Box&lt;T&gt;, Rc&lt;T&gt;, or RefCell&lt;T&gt;</a></li>
</ul>
</li>
<li><a href="#interior-mutability-a-mutable-borrow-to-an-immutable-value">Interior Mutability: A Mutable Borrow to an Immutable Value</a>
<ul>
<li><a href="#a-use-case-for-interior-mutability-mock-objects">A Use Case for Interior Mutability: Mock Objects</a></li>
<li><a href="#keeping-track-of-borrows-at-runtime-with-refcellt">Keeping Track of Borrows at Runtime with RefCell&lt;T&gt;</a></li>
</ul>
</li>
<li><a href="#having-multiple-owners-of-mutable-data-by-combining-rct-and-refcellt">Having Multiple Owners of Mutable Data by Combining Rc&lt;T&gt; and RefCell&lt;T&gt;</a></li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sun Jan  8 14:31:11 UTC 2023 -->
<!--te-->
<h2 id="interior-mutability"><a class="header" href="#interior-mutability">Interior Mutability</a></h2>
<p><em>Interior mutability</em> is a design pattern in Rust that allows you to mutate
data even when there are immutable references to that data; normally, this
action is disallowed by the borrowing rules.</p>
<blockquote>
<p>To mutate data, the pattern uses
<code>unsafe</code> code inside a data structure to bend Rust’s usual rules that govern
mutation and borrowing.</p>
</blockquote>
<p>Unsafe code indicates to the compiler that we’re
checking the rules manually instead of relying on the compiler to check them
for us; we will discuss unsafe code more in Chapter 19.</p>
<p>We can use types that use the interior mutability pattern only when we can
ensure that the borrowing rules will be followed at runtime, even though the
compiler can’t guarantee that. The <code>unsafe</code> code involved is then wrapped in a
safe API, and the outer type is still immutable.</p>
<p>Let’s explore this concept by looking at the <code>RefCell&lt;T&gt;</code> type that follows the
interior mutability pattern.</p>
<h2 id="enforcing-borrowing-rules-at-runtime-with-refcellt"><a class="header" href="#enforcing-borrowing-rules-at-runtime-with-refcellt">Enforcing Borrowing Rules at Runtime with <code>RefCell&lt;T&gt;</code></a></h2>
<p>Unlike <code>Rc&lt;T&gt;</code>, the <code>RefCell&lt;T&gt;</code> type represents single ownership over the data
it holds.</p>
<blockquote>
<p>So, what makes <code>RefCell&lt;T&gt;</code> different from a type like <code>Box&lt;T&gt;</code>?</p>
</blockquote>
<p>Recall the borrowing rules you learned in Chapter 4:</p>
<ul>
<li>At any given time, you can have <em>either</em> (but not both) one mutable reference
or any number of immutable references.</li>
<li>References must always be valid.</li>
</ul>
<blockquote>
<p>Box<T> at compile time: With references and <code>Box&lt;T&gt;</code>, the borrowing rules’ invariants are enforced at
compile time.</p>
</blockquote>
<blockquote>
<p>Refcell<T> at runtime: With <code>RefCell&lt;T&gt;</code>, these invariants are enforced <em>at runtime</em>.</p>
</blockquote>
<ul>
<li>With references, if you break these rules, you’ll get a compiler error.</li>
<li>With <code>RefCell&lt;T&gt;</code>, if you break these rules, your program will panic and exit.</li>
</ul>
<blockquote>
<p>The advantages of checking the borrowing rules at compile time are that errors
will be caught sooner in the development process, and there is no impact on
runtime performance because all the analysis is completed beforehand.</p>
</blockquote>
<p>For those
reasons, checking the borrowing rules at compile time is the best choice in the
majority of cases, which is why this is Rust’s default.</p>
<blockquote>
<p>The advantage of checking the borrowing rules at runtime instead is that
certain memory-safe scenarios are then allowed, where they would’ve been
disallowed by the compile-time checks.</p>
</blockquote>
<p>Static analysis, like the Rust compiler,
is inherently conservative.</p>
<blockquote>
<p>Some properties of code are impossible to detect by
analyzing the code: the most famous example is the Halting Problem, which is
beyond the scope of this book but is an interesting topic to research.</p>
</blockquote>
<p>Because some analysis is impossible, if the Rust compiler can’t be sure the
code complies with the ownership rules, it might reject a correct program; in
this way, it’s conservative.</p>
<p>If Rust accepted an incorrect program, users
wouldn’t be able to trust in the guarantees Rust makes.</p>
<blockquote>
<p>However, if Rust
rejects a correct program, the programmer will be inconvenienced, but nothing
catastrophic can occur. The <code>RefCell&lt;T&gt;</code> type is useful when you’re sure your
code follows the borrowing rules but the compiler is unable to understand and
guarantee that.</p>
</blockquote>
<p>Similar to <code>Rc&lt;T&gt;</code>, <code>RefCell&lt;T&gt;</code> is only for use in single-threaded scenarios
and will give you a compile-time error if you try using it in a multithreaded
context.</p>
<blockquote>
<p>We’ll talk about how to get the functionality of <code>RefCell&lt;T&gt;</code> in a
multithreaded program in Chapter 16.</p>
</blockquote>
<h3 id="the-reasons-to-choose-boxt-rct-or-refcellt"><a class="header" href="#the-reasons-to-choose-boxt-rct-or-refcellt">the reasons to choose <code>Box&lt;T&gt;</code>, <code>Rc&lt;T&gt;</code>, or <code>RefCell&lt;T&gt;</code></a></h3>
<p>Here is a recap of the reasons to choose <code>Box&lt;T&gt;</code>, <code>Rc&lt;T&gt;</code>, or <code>RefCell&lt;T&gt;</code>:</p>
<ul>
<li><code>Rc&lt;T&gt;</code> enables multiple owners of the same data; <code>Box&lt;T&gt;</code> and <code>RefCell&lt;T&gt;</code>
have single owners.</li>
<li><code>Box&lt;T&gt;</code> allows immutable or mutable borrows checked at compile time; <code>Rc&lt;T&gt;</code>
allows only immutable borrows checked at compile time; <code>RefCell&lt;T&gt;</code> allows
immutable or mutable borrows checked at runtime.</li>
<li>Because <code>RefCell&lt;T&gt;</code> allows mutable borrows checked at runtime, you can
mutate the value inside the <code>RefCell&lt;T&gt;</code> even when the <code>RefCell&lt;T&gt;</code> is
immutable.</li>
</ul>
<p>Mutating the value inside an immutable value is the <em>interior mutability</em>
pattern. Let’s look at a situation in which interior mutability is useful and
examine how it’s possible.</p>
<h2 id="interior-mutability-a-mutable-borrow-to-an-immutable-value"><a class="header" href="#interior-mutability-a-mutable-borrow-to-an-immutable-value">Interior Mutability: A Mutable Borrow to an Immutable Value</a></h2>
<p>A consequence of the borrowing rules is that when you have an immutable value,
you can’t borrow it mutably. For example, this code won’t compile:</p>
<pre><code class="language-rust ignore does_not_compile">fn main() {
    let x = 5;
    let y = &amp;mut x;
}
</code></pre>
<p>If you tried to compile this code, you’d get the following error:</p>
<pre><code class="language-console">$ cargo run
   Compiling borrowing v0.1.0 (file:///projects/borrowing)
error[E0596]: cannot borrow `x` as mutable, as it is not declared as mutable
 --&gt; src/main.rs:3:13
  |
2 |     let x = 5;
  |         - help: consider changing this to be mutable: `mut x`
3 |     let y = &amp;mut x;
  |             ^^^^^^ cannot borrow as mutable

For more information about this error, try `rustc --explain E0596`.
error: could not compile `borrowing` due to previous error
</code></pre>
<blockquote>
<p>However, there are situations in which it would be useful for a value to mutate
itself in its methods but appear immutable to other code.</p>
</blockquote>
<ul>
<li>Code outside the value’s methods would not be able to mutate the value.</li>
<li>Using <code>RefCell&lt;T&gt;</code> is one way to get the ability to have interior mutability, but <code>RefCell&lt;T&gt;</code>
doesn’t get around the borrowing rules completely: the borrow checker in the
compiler allows this interior mutability, and the borrowing rules are checked
at runtime instead.</li>
<li>If you violate the rules, you’ll get a <code>panic!</code> instead of
a compiler error.</li>
</ul>
<p>Let’s work through a practical example where we can use <code>RefCell&lt;T&gt;</code> to mutate
an immutable value and see why that is useful.</p>
<h3 id="a-use-case-for-interior-mutability-mock-objects"><a class="header" href="#a-use-case-for-interior-mutability-mock-objects">A Use Case for Interior Mutability: Mock Objects</a></h3>
<p>Sometimes during testing a programmer will use a type in place of another type,
in order to observe particular behavior and assert it’s implemented correctly.</p>
<blockquote>
<p>This placeholder type is called a <em>test double</em>.</p>
</blockquote>
<p>Think of it in the sense of a
“stunt double” in filmmaking, where a person steps in and substitutes for an
actor to do a particular tricky scene. Test doubles stand in for other types
when we’re running tests.</p>
<blockquote>
<p><em>Mock objects</em> are specific types of test doubles
that record what happens during a test so you can assert that the correct
actions took place.</p>
</blockquote>
<p>Rust doesn’t have objects in the same sense as other languages have objects,
and Rust doesn’t have mock object functionality built into the standard library
as some other languages do.</p>
<blockquote>
<p>However, you can definitely create a struct that
will serve the same purposes as a mock object.</p>
</blockquote>
<blockquote>
<p>Here’s the scenario we’ll test:</p>
</blockquote>
<ul>
<li>we’ll create a library that tracks a value
against a maximum value and sends messages based on how close to the maximum
value the current value is.</li>
<li>This library could be used to keep track of a
user’s quota for the number of API calls they’re allowed to make, for example.</li>
<li>Our library will only provide the functionality of tracking how close to the
maximum a value is and what the messages should be at what times.</li>
<li>Applications that use our library will be expected to provide the mechanism for sending the
messages: the application could put a message in the application, send an
email, send a text message, or something else. The library doesn’t need to know
that detail.</li>
<li>All it needs is something that implements a trait we’ll provide
called <code>Messenger</code>.</li>
</ul>
<p>Listing 15-20 shows the library code:</p>
<p><span class="filename">Filename: src/lib.rs</span></p>
<pre><code class="language-rust noplayground">pub trait Messenger {
    fn send(&amp;self, msg: &amp;str);
}

pub struct LimitTracker&lt;'a, T: Messenger&gt; {
    messenger: &amp;'a T,
    value: usize,
    max: usize,
}

impl&lt;'a, T&gt; LimitTracker&lt;'a, T&gt;
where
    T: Messenger,
{
    pub fn new(messenger: &amp;'a T, max: usize) -&gt; LimitTracker&lt;'a, T&gt; {
        LimitTracker {
            messenger,
            value: 0,
            max,
        }
    }

    pub fn set_value(&amp;mut self, value: usize) {
        self.value = value;

        let percentage_of_max = self.value as f64 / self.max as f64;

        if percentage_of_max &gt;= 1.0 {
            self.messenger.send(&quot;Error: You are over your quota!&quot;);
        } else if percentage_of_max &gt;= 0.9 {
            self.messenger
                .send(&quot;Urgent warning: You've used up over 90% of your quota!&quot;);
        } else if percentage_of_max &gt;= 0.75 {
            self.messenger
                .send(&quot;Warning: You've used up over 75% of your quota!&quot;);
        }
    }
}
</code></pre>
<p><span class="caption">Listing 15-20: A library to keep track of how close a
value is to a maximum value and warn when the value is at certain levels</span></p>
<blockquote>
<p>One important part of this code is that the <code>Messenger</code> trait has one method
called <code>send</code> that takes an immutable reference to <code>self</code> and the text of the
message.</p>
</blockquote>
<ul>
<li>This trait is the interface our mock object needs to implement so that
the mock can be used in the same way a real object is.</li>
</ul>
<blockquote>
<p>The other important part
is that we want to test the behavior of the <code>set_value</code> method on the
<code>LimitTracker</code>.</p>
</blockquote>
<p>We can change what we pass in for the <code>value</code> parameter, but
<code>set_value</code> doesn’t return anything for us to make assertions on. We want to be
able to say that if we create a <code>LimitTracker</code> with something that implements
the <code>Messenger</code> trait and a particular value for <code>max</code>, when we pass different
numbers for <code>value</code>, the messenger is told to send the appropriate messages.</p>
<p>We need a mock object that, instead of sending an email or text message when we
call <code>send</code>, will only keep track of the messages it’s told to send. We can
create a new instance of the mock object, create a <code>LimitTracker</code> that uses the
mock object, call the <code>set_value</code> method on <code>LimitTracker</code>, and then check that
the mock object has the messages we expect. Listing 15-21 shows an attempt to
implement a mock object to do just that, but the borrow checker won’t allow it:</p>
<p><span class="filename">Filename: src/lib.rs</span></p>
<pre><code class="language-rust ignore does_not_compile"><span class="boring">pub trait Messenger {
</span><span class="boring">    fn send(&amp;self, msg: &amp;str);
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub struct LimitTracker&lt;'a, T: Messenger&gt; {
</span><span class="boring">    messenger: &amp;'a T,
</span><span class="boring">    value: usize,
</span><span class="boring">    max: usize,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl&lt;'a, T&gt; LimitTracker&lt;'a, T&gt;
</span><span class="boring">where
</span><span class="boring">    T: Messenger,
</span><span class="boring">{
</span><span class="boring">    pub fn new(messenger: &amp;'a T, max: usize) -&gt; LimitTracker&lt;'a, T&gt; {
</span><span class="boring">        LimitTracker {
</span><span class="boring">            messenger,
</span><span class="boring">            value: 0,
</span><span class="boring">            max,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    pub fn set_value(&amp;mut self, value: usize) {
</span><span class="boring">        self.value = value;
</span><span class="boring">
</span><span class="boring">        let percentage_of_max = self.value as f64 / self.max as f64;
</span><span class="boring">
</span><span class="boring">        if percentage_of_max &gt;= 1.0 {
</span><span class="boring">            self.messenger.send(&quot;Error: You are over your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.9 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Urgent warning: You've used up over 90% of your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.75 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Warning: You've used up over 75% of your quota!&quot;);
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>#[cfg(test)]
mod tests {
    use super::*;

    struct MockMessenger {
        sent_messages: Vec&lt;String&gt;,
    }

    impl MockMessenger {
        fn new() -&gt; MockMessenger {
            MockMessenger {
                sent_messages: vec![],
            }
        }
    }

    impl Messenger for MockMessenger {
        fn send(&amp;self, message: &amp;str) {
            self.sent_messages.push(String::from(message));
        }
    }

    #[test]
    fn it_sends_an_over_75_percent_warning_message() {
        let mock_messenger = MockMessenger::new();
        let mut limit_tracker = LimitTracker::new(&amp;mock_messenger, 100);

        limit_tracker.set_value(80);

        assert_eq!(mock_messenger.sent_messages.len(), 1);
    }
}
</code></pre>
<p><span class="caption">Listing 15-21: An attempt to implement a <code>MockMessenger</code>
that isn’t allowed by the borrow checker</span></p>
<ul>
<li>This test code defines a <code>MockMessenger</code> struct that has a <code>sent_messages</code>
field with a <code>Vec</code> of <code>String</code> values to keep track of the messages it’s told
to send.</li>
<li>We also define an associated function <code>new</code> to make it convenient to
create new <code>MockMessenger</code> values that start with an empty list of messages.</li>
<li>We then implement the <code>Messenger</code> trait for <code>MockMessenger</code> so we can give a
<code>MockMessenger</code> to a <code>LimitTracker</code>.</li>
<li>In the definition of the <code>send</code> method, we
take the message passed in as a parameter and store it in the <code>MockMessenger</code>
list of <code>sent_messages</code>.</li>
</ul>
<blockquote>
<p>In the test, we’re testing what happens when the <code>LimitTracker</code> is told to set
<code>value</code> to something that is more than 75 percent of the <code>max</code> value.</p>
</blockquote>
<ul>
<li>First, we create a new <code>MockMessenger</code>, which will start with an empty list of messages.</li>
<li>Then we create a new <code>LimitTracker</code> and give it a reference to the new
<code>MockMessenger</code> and a <code>max</code> value of 100.</li>
<li>We call the <code>set_value</code> method on the
<code>LimitTracker</code> with a value of 80, which is more than 75 percent of 100.</li>
<li>Then we assert that the list of messages that the <code>MockMessenger</code> is keeping track
of should now have one message in it.</li>
</ul>
<p>However, there’s one problem with this test, as shown here:</p>
<pre><code class="language-console">$ cargo test
   Compiling limit-tracker v0.1.0 (file:///projects/limit-tracker)
error[E0596]: cannot borrow `self.sent_messages` as mutable, as it is behind a `&amp;` reference
  --&gt; src/lib.rs:58:13
   |
2  |     fn send(&amp;self, msg: &amp;str);
   |             ----- help: consider changing that to be a mutable reference: `&amp;mut self`
...
58 |             self.sent_messages.push(String::from(message));
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `self` is a `&amp;` reference, so the data it refers to cannot be borrowed as mutable

For more information about this error, try `rustc --explain E0596`.
error: could not compile `limit-tracker` due to previous error
warning: build failed, waiting for other jobs to finish...
</code></pre>
<ul>
<li>We can’t modify the <code>MockMessenger</code> to keep track of the messages, because the
<code>send</code> method takes an immutable reference to <code>self</code>.</li>
<li>We also can’t take the
suggestion from the error text to use <code>&amp;mut self</code> instead, because then the
signature of <code>send</code> wouldn’t match the signature in the <code>Messenger</code> trait
definition (feel free to try and see what error message you get).</li>
</ul>
<blockquote>
<p>This is a situation in which interior mutability can help!</p>
</blockquote>
<ul>
<li>We’ll store the <code>sent_messages</code> within a <code>RefCell&lt;T&gt;</code>,</li>
<li>and then the <code>send</code> method will be
able to modify <code>sent_messages</code> to store the messages we’ve seen.</li>
</ul>
<p>Listing 15-22 shows what that looks like:</p>
<p><span class="filename">Filename: src/lib.rs</span></p>
<pre><code class="language-rust noplayground"><span class="boring">pub trait Messenger {
</span><span class="boring">    fn send(&amp;self, msg: &amp;str);
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub struct LimitTracker&lt;'a, T: Messenger&gt; {
</span><span class="boring">    messenger: &amp;'a T,
</span><span class="boring">    value: usize,
</span><span class="boring">    max: usize,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl&lt;'a, T&gt; LimitTracker&lt;'a, T&gt;
</span><span class="boring">where
</span><span class="boring">    T: Messenger,
</span><span class="boring">{
</span><span class="boring">    pub fn new(messenger: &amp;'a T, max: usize) -&gt; LimitTracker&lt;'a, T&gt; {
</span><span class="boring">        LimitTracker {
</span><span class="boring">            messenger,
</span><span class="boring">            value: 0,
</span><span class="boring">            max,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    pub fn set_value(&amp;mut self, value: usize) {
</span><span class="boring">        self.value = value;
</span><span class="boring">
</span><span class="boring">        let percentage_of_max = self.value as f64 / self.max as f64;
</span><span class="boring">
</span><span class="boring">        if percentage_of_max &gt;= 1.0 {
</span><span class="boring">            self.messenger.send(&quot;Error: You are over your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.9 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Urgent warning: You've used up over 90% of your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.75 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Warning: You've used up over 75% of your quota!&quot;);
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>#[cfg(test)]
mod tests {
    use super::*;
    use std::cell::RefCell;

    struct MockMessenger {
        sent_messages: RefCell&lt;Vec&lt;String&gt;&gt;,
    }

    impl MockMessenger {
        fn new() -&gt; MockMessenger {
            MockMessenger {
                sent_messages: RefCell::new(vec![]),
            }
        }
    }

    impl Messenger for MockMessenger {
        fn send(&amp;self, message: &amp;str) {
            self.sent_messages.borrow_mut().push(String::from(message));
        }
    }

    #[test]
    fn it_sends_an_over_75_percent_warning_message() {
        // --snip--
<span class="boring">        let mock_messenger = MockMessenger::new();
</span><span class="boring">        let mut limit_tracker = LimitTracker::new(&amp;mock_messenger, 100);
</span><span class="boring">
</span><span class="boring">        limit_tracker.set_value(80);
</span>
        assert_eq!(mock_messenger.sent_messages.borrow().len(), 1);
    }
}
</code></pre>
<p><span class="caption">Listing 15-22: Using <code>RefCell&lt;T&gt;</code> to mutate an inner
value while the outer value is considered immutable</span></p>
<ul>
<li>The <code>sent_messages</code> field is now of type <code>RefCell&lt;Vec&lt;String&gt;&gt;</code> instead of
<code>Vec&lt;String&gt;</code>.</li>
<li>In the <code>new</code> function, we create a new <code>RefCell&lt;Vec&lt;String&gt;&gt;</code>
instance around the empty vector.</li>
<li>For the implementation of the <code>send</code> method, the first parameter is still an
immutable borrow of <code>self</code>, which matches the trait definition.</li>
<li>We call
<code>borrow_mut</code> on the <code>RefCell&lt;Vec&lt;String&gt;&gt;</code> in <code>self.sent_messages</code> to get a
mutable reference to the value inside the <code>RefCell&lt;Vec&lt;String&gt;&gt;</code>, which is the
vector.</li>
<li>Then we can call <code>push</code> on the mutable reference to the vector to keep
track of the messages sent during the test.</li>
</ul>
<blockquote>
<p>The last change we have to make is in the assertion:
to see how many items are in the inner vector, we call <code>borrow</code> on the <code>RefCell&lt;Vec&lt;String&gt;&gt;</code> to get an
immutable reference to the vector.</p>
</blockquote>
<p>Now that you’ve seen how to use <code>RefCell&lt;T&gt;</code>, let’s dig into how it works!</p>
<h3 id="keeping-track-of-borrows-at-runtime-with-refcellt"><a class="header" href="#keeping-track-of-borrows-at-runtime-with-refcellt">Keeping Track of Borrows at Runtime with <code>RefCell&lt;T&gt;</code></a></h3>
<p>When creating immutable and mutable references, we use the <code>&amp;</code> and <code>&amp;mut</code>
syntax, respectively.</p>
<blockquote>
<p>With <code>RefCell&lt;T&gt;</code>, we use the <code>borrow</code> and <code>borrow_mut</code>
methods, which are part of the safe API that belongs to <code>RefCell&lt;T&gt;</code>.</p>
</blockquote>
<ul>
<li>The <code>borrow</code> method returns the smart pointer type <code>Ref&lt;T&gt;</code></li>
<li>and <code>borrow_mut</code> returns the smart pointer type <code>RefMut&lt;T&gt;</code>.</li>
<li>Both types implement <code>Deref</code>, so we
can treat them like regular references.</li>
</ul>
<blockquote>
<p>The <code>RefCell&lt;T&gt;</code> keeps track of how many <code>Ref&lt;T&gt;</code> and <code>RefMut&lt;T&gt;</code> smart
pointers are currently active.</p>
</blockquote>
<ul>
<li>Every time we call <code>borrow</code>, the <code>RefCell&lt;T&gt;</code>
increases its count of how many immutable borrows are active.</li>
<li>When a <code>Ref&lt;T&gt;</code>
value goes out of scope, the count of immutable borrows goes down by one.</li>
<li>Just
like the compile-time borrowing rules, <code>RefCell&lt;T&gt;</code> lets us have many immutable
borrows or one mutable borrow at any point in time.</li>
</ul>
<blockquote>
<p>If we try to violate these rules, rather than getting a compiler error as we
would with references, the implementation of <code>RefCell&lt;T&gt;</code> will panic at
runtime.</p>
</blockquote>
<p>Listing 15-23 shows a modification of the implementation of <code>send</code> in
Listing 15-22. We’re deliberately trying to create two mutable borrows active
for the same scope to illustrate that <code>RefCell&lt;T&gt;</code> prevents us from doing this
at runtime.</p>
<p><span class="filename">Filename: src/lib.rs</span></p>
<pre><code class="language-rust ignore panics"><span class="boring">pub trait Messenger {
</span><span class="boring">    fn send(&amp;self, msg: &amp;str);
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub struct LimitTracker&lt;'a, T: Messenger&gt; {
</span><span class="boring">    messenger: &amp;'a T,
</span><span class="boring">    value: usize,
</span><span class="boring">    max: usize,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl&lt;'a, T&gt; LimitTracker&lt;'a, T&gt;
</span><span class="boring">where
</span><span class="boring">    T: Messenger,
</span><span class="boring">{
</span><span class="boring">    pub fn new(messenger: &amp;'a T, max: usize) -&gt; LimitTracker&lt;'a, T&gt; {
</span><span class="boring">        LimitTracker {
</span><span class="boring">            messenger,
</span><span class="boring">            value: 0,
</span><span class="boring">            max,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    pub fn set_value(&amp;mut self, value: usize) {
</span><span class="boring">        self.value = value;
</span><span class="boring">
</span><span class="boring">        let percentage_of_max = self.value as f64 / self.max as f64;
</span><span class="boring">
</span><span class="boring">        if percentage_of_max &gt;= 1.0 {
</span><span class="boring">            self.messenger.send(&quot;Error: You are over your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.9 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Urgent warning: You've used up over 90% of your quota!&quot;);
</span><span class="boring">        } else if percentage_of_max &gt;= 0.75 {
</span><span class="boring">            self.messenger
</span><span class="boring">                .send(&quot;Warning: You've used up over 75% of your quota!&quot;);
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cfg(test)]
</span><span class="boring">mod tests {
</span><span class="boring">    use super::*;
</span><span class="boring">    use std::cell::RefCell;
</span><span class="boring">
</span><span class="boring">    struct MockMessenger {
</span><span class="boring">        sent_messages: RefCell&lt;Vec&lt;String&gt;&gt;,
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    impl MockMessenger {
</span><span class="boring">        fn new() -&gt; MockMessenger {
</span><span class="boring">            MockMessenger {
</span><span class="boring">                sent_messages: RefCell::new(vec![]),
</span><span class="boring">            }
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span>    impl Messenger for MockMessenger {
        fn send(&amp;self, message: &amp;str) {
            let mut one_borrow = self.sent_messages.borrow_mut();
            let mut two_borrow = self.sent_messages.borrow_mut();

            one_borrow.push(String::from(message));
            two_borrow.push(String::from(message));
        }
    }
<span class="boring">
</span><span class="boring">    #[test]
</span><span class="boring">    fn it_sends_an_over_75_percent_warning_message() {
</span><span class="boring">        let mock_messenger = MockMessenger::new();
</span><span class="boring">        let mut limit_tracker = LimitTracker::new(&amp;mock_messenger, 100);
</span><span class="boring">
</span><span class="boring">        limit_tracker.set_value(80);
</span><span class="boring">
</span><span class="boring">        assert_eq!(mock_messenger.sent_messages.borrow().len(), 1);
</span><span class="boring">    }
</span><span class="boring">}
</span></code></pre>
<p><span class="caption">Listing 15-23: Creating two mutable references in the
same scope to see that <code>RefCell&lt;T&gt;</code> will panic</span></p>
<ul>
<li>We create a variable <code>one_borrow</code> for the <code>RefMut&lt;T&gt;</code> smart pointer returned
from <code>borrow_mut</code>.</li>
<li>Then we create another mutable borrow in the same way in the
variable <code>two_borrow</code>.</li>
<li>This makes two mutable references in the same scope,
which isn’t allowed.</li>
<li>When we run the tests for our library, the code in Listing
15-23 will compile without any errors, but the test will fail:</li>
</ul>
<pre><code class="language-console">$ cargo test
   Compiling limit-tracker v0.1.0 (file:///projects/limit-tracker)
    Finished test [unoptimized + debuginfo] target(s) in 0.91s
     Running unittests src/lib.rs (target/debug/deps/limit_tracker-e599811fa246dbde)

running 1 test
test tests::it_sends_an_over_75_percent_warning_message ... FAILED

failures:

---- tests::it_sends_an_over_75_percent_warning_message stdout ----
thread 'main' panicked at 'already borrowed: BorrowMutError', src/lib.rs:60:53
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    tests::it_sends_an_over_75_percent_warning_message

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

error: test failed, to rerun pass '--lib'
</code></pre>
<p>Notice that the code panicked with the message <code>already borrowed: BorrowMutError</code>. This is how <code>RefCell&lt;T&gt;</code> handles violations of the borrowing
rules at runtime.</p>
<blockquote>
<p>Choosing to catch borrowing errors at runtime rather than compile time, as
we’ve done here, means you’d potentially be finding mistakes in your code later
in the development process:</p>
</blockquote>
<ul>
<li>possibly not until your code was deployed to
production.</li>
<li>Also, your code would incur a small runtime performance penalty as
a result of keeping track of the borrows at runtime rather than compile time.</li>
</ul>
<blockquote>
<p>However, using <code>RefCell&lt;T&gt;</code> makes it possible to write a mock object that can
modify itself to keep track of the messages it has seen while you’re using it
in a context where only immutable values are allowed.</p>
</blockquote>
<p>You can use <code>RefCell&lt;T&gt;</code> despite its trade-offs to get more functionality than regular references provide.</p>
<h2 id="having-multiple-owners-of-mutable-data-by-combining-rct-and-refcellt"><a class="header" href="#having-multiple-owners-of-mutable-data-by-combining-rct-and-refcellt">Having Multiple Owners of Mutable Data by Combining <code>Rc&lt;T&gt;</code> and <code>RefCell&lt;T&gt;</code></a></h2>
<p>A common way to use <code>RefCell&lt;T&gt;</code> is in combination with <code>Rc&lt;T&gt;</code>. Recall that
<code>Rc&lt;T&gt;</code> lets you have multiple owners of some data, but it only gives immutable
access to that data.</p>
<blockquote>
<p>If you have an <code>Rc&lt;T&gt;</code> that holds a <code>RefCell&lt;T&gt;</code>, you can
get a value that can have multiple owners <em>and</em> that you can mutate!</p>
</blockquote>
<ul>
<li>For example, recall the cons list example in Listing 15-18 where we used
<code>Rc&lt;T&gt;</code> to allow multiple lists to share ownership of another list.</li>
<li>Because
<code>Rc&lt;T&gt;</code> holds only immutable values, we can’t change any of the values in the
list once we’ve created them.</li>
<li>Let’s add in <code>RefCell&lt;T&gt;</code> to gain the ability to
change the values in the lists.</li>
</ul>
<p>Listing 15-24 shows that by using a
<code>RefCell&lt;T&gt;</code> in the <code>Cons</code> definition, we can modify the value stored in all
the lists:</p>
<p><span class="filename">Filename: src/main.rs</span></p>
<pre><code class="language-rust  ignore">#[derive(Debug)]
enum List {
    Cons(Rc&lt;RefCell&lt;i32&gt;&gt;, Rc&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

fn main() {
    let value = Rc::new(RefCell::new(5));

    let a = Rc::new(Cons(Rc::clone(&amp;value), Rc::new(Nil)));

    let b = Cons(Rc::new(RefCell::new(3)), Rc::clone(&amp;a));
    let c = Cons(Rc::new(RefCell::new(4)), Rc::clone(&amp;a));

    *value.borrow_mut() += 10;

    println!(&quot;a after = {:?}&quot;, a);
    println!(&quot;b after = {:?}&quot;, b);
    println!(&quot;c after = {:?}&quot;, c);
}
</code></pre>
<p><span class="caption">Listing 15-24: Using <code>Rc&lt;RefCell&lt;i32&gt;&gt;</code> to create a
<code>List</code> that we can mutate</span></p>
<ul>
<li>We create a value that is an instance of <code>Rc&lt;RefCell&lt;i32&gt;&gt;</code> and store it in a
variable named <code>value</code> so we can access it directly later.</li>
<li>Then we create a <code>List</code> in <code>a</code> with a <code>Cons</code> variant that holds <code>value</code>.</li>
<li>We need to clone <code>value</code> so both <code>a</code> and <code>value</code> have ownership of the inner <code>5</code> value rather
than transferring ownership from <code>value</code> to <code>a</code> or having <code>a</code> borrow from
<code>value</code>.</li>
</ul>
<p>We wrap the list <code>a</code> in an <code>Rc&lt;T&gt;</code> so when we create lists <code>b</code> and <code>c</code>, they
can both refer to <code>a</code>, which is what we did in Listing 15-18.</p>
<p>After we’ve created the lists in <code>a</code>, <code>b</code>, and <code>c</code>, we want to add 10 to the
value in <code>value</code>. We do this by calling <code>borrow_mut</code> on <code>value</code>, which uses the
automatic dereferencing feature we discussed in Chapter 5 (see the section
<a href="ch05-03-method-syntax.html#wheres-the---operator">“Where’s the <code>-&gt;</code> Operator?”</a><!-- ignore -->) to
dereference the <code>Rc&lt;T&gt;</code> to the inner <code>RefCell&lt;T&gt;</code> value. The <code>borrow_mut</code>
method returns a <code>RefMut&lt;T&gt;</code> smart pointer, and we use the dereference operator
on it and change the inner value.</p>
<p>When we print <code>a</code>, <code>b</code>, and <code>c</code>, we can see that they all have the modified
value of 15 rather than 5:</p>
<pre><code class="language-console">$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
    Finished dev [unoptimized + debuginfo] target(s) in 0.63s
     Running `target/debug/cons-list`
a after = Cons(RefCell { value: 15 }, Nil)
b after = Cons(RefCell { value: 3 }, Cons(RefCell { value: 15 }, Nil))
c after = Cons(RefCell { value: 4 }, Cons(RefCell { value: 15 }, Nil))
</code></pre>
<blockquote>
<p>This technique is pretty neat!</p>
</blockquote>
<ul>
<li>By using <code>RefCell&lt;T&gt;</code>, we have an outwardly
immutable <code>List</code> value.</li>
<li>But we can use the methods on <code>RefCell&lt;T&gt;</code> that provide
access to its interior mutability so we can modify our data when we need to.</li>
<li>The runtime checks of the borrowing rules protect us from data races, and it’s
sometimes worth trading a bit of speed for this flexibility in our data
structures.</li>
</ul>
<blockquote>
<p>Note that <code>RefCell&lt;T&gt;</code> does not work for multithreaded code!
<code>Mutex&lt;T&gt;</code> is the thread-safe version of <code>RefCell&lt;T&gt;</code> and we’ll discuss
<code>Mutex&lt;T&gt;</code> in Chapter 16.</p>
</blockquote>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="ch15-04-rc.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="ch15-06-reference-cycles.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="ch15-04-rc.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="ch15-06-reference-cycles.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/ferris/ferris.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
